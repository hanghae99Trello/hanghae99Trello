<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>할일헤븐</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/board_style.css}" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Arbutus+Slab" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.0/spectrum.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.0/spectrum.min.js"></script>
    <script type="text/javascript" th:src="@{/js/board_js.js}"></script>
</head>
<body>
    <div class="board_container" th:data-board-id="${boardId}">
        <div id="p1" class="mdl-progress mdl-js-progress"></div>
        <div class="kanban__title">
            <h1>
                <i class="material-icons">check</i> To do list
            </h1>
        </div>
        <div class="flex_container">
            <div class="dd" th:each="column : ${board.colList}">
                <ol class="kanban To-do">
                    <div class="kanban__title">
                        <h2 th:text="${column.colName}">Column Name</h2>
                    </div>
                    <li class="dd-item">
                        <h3 class="title dd-handle">
                            <span></span>
                        </h3>
                        <div class="actions">
                            <button class="addbutt">
                                <i class="material-icons">control_point</i> Add new
                            </button>
                        </div>
                    </li>
                </ol>
            </div>
        </div>
        <menu class="kanban">
            <button id="openFormButton">
                <i class="material-icons">settings</i>
            </button>
            <button>
                <i class="material-icons">chevron_left</i>
            </button>
            <button class="viewkanban">
                <i class="material-icons ">view_column</i>
            </button>
            <button class="viewlist">
                <i class="material-icons">view_list</i>
            </button>
            <button class="add-column-button" onclick="openColumnForm()">
                <i class="material-icons">playlist_add</i> Add new Column
            </button>
        </menu>

        <div class="popup-form" id="columnForm">
            <form id="addColumnForm">
                <div id="columnFormErrorMessage" style="font-weight: 100; color: red; margin-bottom: 10px;"></div>
                <input type="text" id="colName" name="colName" placeholder="Column Name" required><br>
                <input type="text" id="colIndex" name="colIndex" placeholder="Column Index" required><br>
                <button type="button" onclick="submitColumnForm()">Create Column</button>
                <button type="button" onclick="closeColumnForm()">Close</button>
            </form>
        </div>

        <div class="popup-form" id="boardEditForm" style="display: none;">
            <form id="editBoardForm">
                <div id="editBoardFormErrorMessage" style="font-weight: 100; color: red; margin-bottom: 10px;"></div>
                <input type="text" id="boardName" name="boardName" placeholder="Board Name" required><br>
                <input type="text" id="boardColor" name="boardColor" placeholder="Board Color" required><br>
                <input type="text" id="boardDescription" name="boardDescription" placeholder="Board Description" required><br>
                <input type="text" id="participants" name="participants" placeholder="Participants"><br>
                <button type="button" onclick="submitBoardEditForm()">Update Board</button>
                <button type="button" onclick="closeBoardEditForm()">Close</button>
            </form>
        </div>
    </div>
    <script>
        document.querySelector('#p1').addEventListener('mdl-componentupgraded', function() {
            this.MaterialProgress.setProgress(44);
        });
        function openColumnForm() {
            document.getElementById("columnForm").style.display = "block";
        }

        function closeColumnForm() {
            document.getElementById("columnForm").style.display = "none";
        }

        function submitColumnForm() {
            const boardContainer = document.querySelector('.board_container');
            const boardId = boardContainer.getAttribute('data-board-id');

            const colName = document.getElementById("colName").value;
            const colIndex = document.getElementById("colIndex").value;

            const data = {
                colName: colName,
                colIndex: colIndex
            };

            fetch(`/api/users/boards/${boardId}/columns`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Success:', data);
                    closeColumnForm();
                    location.reload();
                })
                .catch((error) => {
                    console.error('Error:', error);
                    document.getElementById("columnFormErrorMessage").textContent = "컬럼 생성에 실패했습니다.";
                });
        }

        document.getElementById("openFormButton").addEventListener("click", function() {
            document.getElementById("boardEditForm").style.display = "block";
        });

        function closeBoardEditForm() {
            document.getElementById("boardEditForm").style.display = "none";
        }

        function submitBoardEditForm() {
            const boardName = document.getElementById("boardName").value;
            const boardDescription = document.getElementById("boardDescription").value;
            const boardColor = document.getElementById("boardColor").value;
            const participantsInput = document.getElementById("participants");
            let participants = [];

            if (participantsInput != null && participantsInput.value.indexOf(",") !== -1) {
                participants = participantsInput.value.split(",").map(participant => participant.trim());
            }

            const data = {
                boardName: boardName,
                boardDescription: boardDescription,
                boardColor: boardColor,
                participants: participants
            };

            const boardContainer = document.querySelector('.board_container');
            const boardId = boardContainer.getAttribute('data-board-id');

            fetch(`/api/users/boards/${boardId}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                closeBoardEditForm();
            })
            .catch(error => {
                console.error("Error updating board:", error);
                document.getElementById("editBoardFormErrorMessage").textContent = "보드 수정에 실패했습니다.";
            });
        }
    </script>
</body>
</html>